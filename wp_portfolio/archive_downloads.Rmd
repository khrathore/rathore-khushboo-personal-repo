---
title: "Senate Data Retrieval from Wayback Archive"
date: "09/08/2023"
author: Khushboo Rathore
---

```{r}
library(xml2)
library(methods)
library(tidyverse)
library(XML)
library(furrr)
library(rvest)
library(httr)
```
# Function to convert xml listings into rows of dataframes. Run this before running the codeblock below.

```{r}
#JUST for second XML, which has some different factors
xml_two_to_table <- function(file_number) {
  xml_listing <- all_listings[[file_number]]
  # Get attributes of filer and office name
  LastName <- xml_attr(xml_listing, "LastName")
  FirstName <- xml_attr(xml_listing, "FirstName")
  OfficeName <- xml_attr(xml_find_first(xml_listing, ".//dbo.Office"), "OfficeName")
  # Create a list of all filings made my the filer
  all_filings <- xml_find_all(xml_listing, ".//dbo.Document")
  traveler_filings <- data.frame()
  #For each filing, extract information and put it in a dataframe
  for(filing_num in 1:length(all_filings)) {
    filing <- all_filings[[filing_num]]
    ReportingYear <- xml_attr(filing, "ReportingYear")
    BeginTravelDate <- xml_attr(filing, "BeginTravelDate")
    EndTravelDate <- xml_attr(filing, "EndTravelDate")
    DateReceived <- xml_attr(filing, "DateReceived")
    TransactionDate <- xml_attr(filing, "TransactionDate")
    Pages <- xml_attr(filing, "Pages")
    ReportTitle <- xml_attr(xml_find_first(filing, ".//dbo.Reports"), "ReportTitle")
    DocURL <- xml_attr(xml_find_first(filing, ".//dbo.Reports"), "DocURL")
    report_data <- c(LastName, FirstName, OfficeName, ReportTitle, ReportingYear, BeginTravelDate, EndTravelDate, DateReceived, TransactionDate, Pages, DocURL)
    traveler_filings <- rbind(traveler_filings, report_data)
  }
  traveler_filings <- setNames(traveler_filings, c("filer_lastname", "filer_firstname", "filer_office", "report_title", "reporting_year", "begin_travel_date", "end_travel_date", "date_received", "transaction_date", "num_pages", "doc_url")) %>% 
    mutate(begin_travel_date = as.Date(begin_travel_date)) %>% 
    mutate(end_travel_date = as.Date(end_travel_date)) %>% 
    mutate(date_received = as.Date(date_received)) %>% 
    mutate(transaction_date = as.Date(transaction_date)) %>% 
    mutate(num_pages = as.double(num_pages)) %>% 
    mutate(reporting_year = as.double(reporting_year))
}

# Function to convert all xml listings into a table for each filer
xml_to_table <- function(file_number) {
  xml_listing <- all_listings[[file_number]]
  # Get attributes of filer and office name
  LastName <- xml_attr(xml_listing, "LastName")
  FirstName <- xml_attr(xml_listing, "FirstName")
  OfficeName <- xml_attr(xml_find_first(xml_listing, ".//dbo.Office"), "OfficeName")
  # Create a list of all filings made my the filer
  all_filings <- xml_find_all(xml_listing, ".//dbo.Document")
  traveler_filings <- data.frame()
  #For each filing, extract information and put it in a dataframe
  for(filing_num in 1:length(all_filings)) {
    filing <- all_filings[[filing_num]]
    ReportingYear <- xml_attr(filing, "ReportingYear")
    BeginTravelDate <- xml_attr(filing, "BeginTravelDate")
    EndTravelDate <- xml_attr(filing, "EndTravelDate")
    DateReceived <- xml_attr(filing, "DateReceived")
    TransactionDate <- xml_attr(filing, "TransactionDate")
    Pages <- xml_attr(filing, "Pages")
    ReportTitle <- xml_attr(xml_find_first(filing, ".//dbo.Reports"), "ReportTitle")
    DocURL <- xml_attr(xml_find_first(filing, ".//dbo.Reports"), "DocURL")
    report_data <- c(LastName, FirstName, OfficeName, ReportTitle, ReportingYear, BeginTravelDate, EndTravelDate, DateReceived, TransactionDate, Pages, DocURL)
    traveler_filings <- rbind(traveler_filings, report_data)
  }
  traveler_filings <- setNames(traveler_filings, c("filer_lastname", "filer_firstname", "filer_office", "report_title", "reporting_year", "begin_travel_date", "end_travel_date", "date_received", "transaction_date", "num_pages", "doc_url")) %>% 
    mutate(begin_travel_date = as.Date(begin_travel_date,  "%m/%d/%Y")) %>% 
    mutate(end_travel_date = as.Date(end_travel_date,  "%m/%d/%Y")) %>% 
    mutate(date_received = as.Date(date_received,  "%m/%d/%Y")) %>% 
    mutate(transaction_date = as.Date(transaction_date,  "%m/%d/%Y")) %>% 
    mutate(num_pages = as.double(num_pages)) %>% 
    mutate(reporting_year = as.double(reporting_year))
}

# Download wayback archive zip files and convert to XML
download_wayback <- function(wayback_number) {
  date <- wayback_dataframe$date[wayback_number]
  link <- wayback_dataframe$urls[wayback_number]
  wayback_response <- GET(link)
  if (wayback_response$status_code == 200) {
  # Parse the HTML content
    zip_loc <- paste0("data/senate_data_archives/senate_data_", date, ".zip") 
    download.file(link, zip_loc)
    # Create a filepath for the XML and unzip the file into the data folder
    xml_loc <- gsub(".zip", ".xml", zip_loc) 
    unzip(zip_loc, exdir = "data/senate_data_archives")
    #Rename the unzipped file to follow project convention
    file.rename("data/senate_data_archives/giftrule.xml", xml_loc)
    file.rename("data/senate_data_archives/GiftRuleData.xml", xml_loc)
} else {
    # Handle errors
    cat("Error: Unable to fetch the Wayback Machine URL\n")
}
}

# JUST for the first XML, which has a different format
xml_one_to_table <- function(file_number) {
  xml_listing <- all_listings[[file_number]]
    LastName = xml_attr(xml_listing, "LastName")
    FirstName = xml_attr(xml_listing, "FirstName")
    OfficeName = xml_attr(xml_listing, "OfficeName")
    all_filings <- xml_find_all(xml_listing, ".//Document")
  traveler_filings <- data.frame()
  #For each filing, extract information and put it in a dataframe
  for(filing_num in 1:length(all_filings)) {
    filing <- all_filings[[filing_num]]
    ReportingYear <- xml_attr(filing, "ReportingYear")
    BeginTravelDate <- xml_attr(filing, "BeginTravelDate")
    EndTravelDate <- xml_attr(filing, "EndTravelDate")
    DateReceived <- xml_attr(filing, "DateReceived")
    TransactionDate <- xml_attr(filing, "TransactionDate")
    Pages <- xml_attr(filing, "Pages")
    ReportTitle <- xml_attr(filing, "FilingType")
    DocURL <- NA
    report_data <- c(LastName, FirstName, OfficeName, ReportTitle, ReportingYear, BeginTravelDate, EndTravelDate, DateReceived, TransactionDate, Pages, DocURL)
    traveler_filings <- rbind(traveler_filings, report_data)
  }
  traveler_filings <- setNames(traveler_filings, c("filer_lastname", "filer_firstname", "filer_office", "report_title", "reporting_year", "begin_travel_date", "end_travel_date", "date_received", "transaction_date", "num_pages", "doc_url")) %>% 
    mutate(begin_travel_date = as.Date(begin_travel_date)) %>% 
    mutate(end_travel_date = as.Date(end_travel_date)) %>% 
    mutate(date_received = as.Date(date_received)) %>% 
    mutate(transaction_date = as.Date(transaction_date)) %>% 
    mutate(num_pages = as.double(num_pages)) %>% 
    mutate(reporting_year = as.double(reporting_year))
}

```

# Downloads archives from about every four years of the senate data

```{r}
# Example URL for the oldest available snapshot
wayback_urls <- c("https://web.archive.org/web/20080131052758/http://soprweb.senate.gov/giftrule/giftruledownload/GiftRuleData.zip", "https://web.archive.org/web/20110605144411/http://soprweb.senate.gov/giftrule/giftruledownload/giftruledata.zip", "https://web.archive.org/web/20150318055851/http://soprweb.senate.gov/giftrule/giftruledownload/giftruledata.zip", "https://web.archive.org/web/20190310121622/http://soprweb.senate.gov/giftrule/giftruledownload/giftruledata.zip", "https://web.archive.org/web/20230302004112/https://giftrule-disclosure.senate.gov/media/giftruledownloads/giftruledata.zip", "https://web.archive.org/web/20130512083149/http://soprweb.senate.gov/giftrule/giftruledownload/GiftRuleData.zip")

wayback_dataframe <- data.frame(urls = unlist(wayback_urls))

wayback_dataframe <- wayback_dataframe |>
  mutate(date_time = gsub("[^0-9]", "", urls)) %>% 
  mutate(parsed_dt = strptime(date_time, format = "%Y%m%d%H%M%S")) %>% 
  mutate(date = as.Date(parsed_dt))

for (number in 1:nrow(wayback_dataframe)) {
  download_wayback(number)
}

```

# Creates CSVs from XMLs of archived data

```{r}
all_xml <- as_tibble(list.files("data/senate_data_archives")) %>% 
  filter(str_detect(value, "xml")) %>% 
  mutate(date = ymd(str_extract(value, "\\d{4}-\\d{2}-\\d{2}")))

```

# XML One
```{r}
xml_loc <- paste0("data/senate_data_archives/", all_xml$value[1])
xml_date <- all_xml$date[1]
char_date <- as.character(xml_date)
current_data <- read_xml(xml_loc)
#Create a list of all the filers and their documents
all_listings <- xml_find_all(current_data, ".//Filer")

  # Speedy for loop to get all the information
filer_travel <- map_dfr(c(1:length(all_listings)), xml_one_to_table) %>% 
  mutate(source = xml_date)
  
csv_loc <- gsub(".xml", ".csv", xmlloc)
write_csv(filer_travel, csv_loc)
```

# XML Two

``` {r}
xml_loc <- paste0("data/senate_data_archives/", all_xml$value[2])
xml_date <- all_xml$date[2]
char_date <- as.character(xml_date)
current_data <- read_xml(xml_loc)
#Create a list of all the filers and their documents
all_listings <- xml_find_all(current_data, ".//dbo.filer")

  # Speedy for loop to get all the information
filer_travel <- map_dfr(c(1:length(all_listings)), xml_two_to_table) %>% 
  mutate(source = xml_date)
  
csv_loc <- gsub(".xml", ".csv", xml_loc)
write_csv(filer_travel, csv_loc)

```

# All the other XMLs

``` {r}
for (xml in 3:nrow(all_xml)) {
xml_loc <- paste0("data/senate_data_archives/", all_xml$value[xml])
xml_date <- all_xml$date[xml]
char_date <- as.character(xml_date)
current_data <- read_xml(xml_loc)
#Create a list of all the filers and their documents
all_listings <- xml_find_all(current_data, ".//dbo.filer")

  # Speedy for loop to get all the information
filer_travel <- map_dfr(c(1:length(all_listings)), xml_to_table) %>% 
  mutate(source = xml_date)
  
csv_loc <- gsub(".xml", ".csv", xml_loc)
write_csv(filer_travel, csv_loc)
}
```

# Upload data from most recent old data and create a list of all filings, including a column that shows what dataset the row came from
```{r}
# List all files in the original data folder
all_files <- as.tibble(list.files("data/senate_data_archives/")) %>% 
  mutate(date = ymd(str_extract(value, "\\d{4}-\\d{2}-\\d{2}"))) %>% 
  filter(str_detect(value, "csv"))

today_date <- Sys.Date()
most_recent_csv <- paste0("data/combined_data/senate_data_", today_date, ".csv")
current_combined <- read_csv(most_recent_csv)

archive_added <- current_combined

#file <- 1
for (file in 1:nrow(all_files)) {
  csv_name <- paste0("data/senate_data_archives/", as.character(all_files$value[file]))
  csv_temp <- read_csv(csv_name)
  archive_added <- archive_added %>% 
    full_join(csv_temp, by = c("filer_lastname", "filer_firstname", "filer_office", "report_title", "reporting_year", "begin_travel_date", "end_travel_date", "date_received", "transaction_date", "num_pages", "doc_url")) %>% 
  mutate(source = case_when(
    is.na(source.x) ~ source.y,
    TRUE~ source.x)) %>% 
  select(-source.x, -source.y)
}

write_csv(archive_added, most_recent_csv)

# Get the file path for the most recent csv
#most_recent_csv <- paste0("/workspaces/congressional-private-travel/data/combined_data/", as.character(all_files[1]))
```